 # 필수 스펙 세분화 (테스트 가능한 작업 단위)

 이 문서는 프로젝트의 PULL_REQUEST_TEMPLATE.md에 적힌 필수 스펙을 더 작은 실행 가능하고 테스트 가능한 작업 단위로 분해한 문서입니다. 구현과 테스트 체크리스트로 사용하세요.

 ---

 ## 개요
 원래의 필수 스펙은 반복 유형 선택, 반복 일정 아이콘 표시, 반복 종료(2025-12-31까지 cap), 편집/삭제 시 단일 인스턴스 vs 전체 시리즈 처리, 그리고 반복 일정은 일정 겹침을 고려하지 않는다는 규칙을 포함합니다. 아래 항목들은 이를 더 작은 단위로 나누고 각 항목에 수용 기준(acceptance criteria)과 권장 테스트를 제시합니다.

 ---

 ## 1) 반복 유형 선택 (폼)
 목표: 일정 생성/수정 폼에서 반복 규칙을 지정할 수 있어야 합니다.

 세부 작업:
 - 1.1 `repeat` 필드 데이터 모델 추가 (단위 테스트)
   - 데이터 형태: { type: 'none'|'daily'|'weekly'|'monthly'|'yearly', interval: number, endDate?: string }
   - 기본값: { type: 'none', interval: 1 }
   - 테스트: 기본값과 입력 검증에 대한 단위 테스트

 - 1.2 폼 UI: `반복 일정` 체크박스 (통합 테스트)
   - 체크하면 `반복 유형`(Select), `반복 간격`(숫자 입력, min=1), `반복 종료일`(date 입력) 컨트롤이 나타나야 함
   - 테스트: 렌더 테스트에서 체크박스 존재 확인, 체크 시 컨트롤 노출 확인

 - 1.3 폼 UI: 반복 유형 옵션 (통합)
   - 옵션: 매일, 매주, 매월, 매년
   - 테스트: Select에 위 네 옵션이 포함되어 있는지 확인

 - 1.4 입력 유효성 (단위/통합)
   - interval은 정수이며 1 이상
   - endDate는 유효한 날짜 문자열(선택적)
   - 테스트: 유효하지 않은 interval/endDate에 대한 에러 처리 확인

 - 1.5 특수 규칙 (단위)
   - 매월 31일 선택 시: 해당 달에 31일이 있는 경우에만 생성(대체하지 않음)
   - 매년 2월 29일 선택 시: 윤년일 때만 생성(대체하지 않음)
   - 테스트: 확장 알고리즘에 대한 유닛 테스트로 위 규칙 검증

 수용 기준:
 - 폼에서 반복을 켜고 유형/간격/종료일을 지정할 수 있어야 함
 - 저장된 이벤트에 올바른 `repeat` 구조가 포함되어야 함

 ---

 ## 2) 반복 확장 유틸(핵심 로직)
 목표: 주어진 범위 내에서 반복 이벤트를 인스턴스로 확장(expand)하는 결정론적 유틸을 구현합니다.

 세부 작업:
 - 2.1 `expandRepeatingEvent(event, rangeStart, rangeEnd)` 구현 (단위)
   - daily/weekly/monthly/yearly 규칙을 처리
   - 범위 종료(rangeEnd)가 cap(2025-12-31)보다 이후면 cap까지 확장
   - 31일/2월29일 규칙을 존중
   - 테스트: daily, weekly, monthly(31일), yearly(2/29), cap 동작 검증

 - 2.2 `expandRepeatingEvents(events[], rangeStart, rangeEnd)` 래퍼 구현
   - 여러 이벤트 결합 결과 검증 테스트

 수용 기준:
 - 유틸이 엣지케이스(31일, 2/29, cap)를 포함한 테스트 매트릭스를 통과
 - 발생 인스턴스 목록이 결정론적이며 각 인스턴스가 고유한 식별자(id)나 파생 id를 가짐

 비고:
 - 유틸은 순수 함수로 유지하고 철저히 유닛 테스트하세요. 필요한 경우 `date-fns` 사용을 고려.

 ---

 ## 3) 캘린더/목록에서 반복 표시
 목표: 반복 일정에는 아이콘을 표시하여 구분할 수 있어야 합니다.

 세부 작업:
 - 3.1 캘린더 셀 렌더 (통합)
   - event.repeat.type !== 'none' 인 경우 이벤트 항목에 작은 반복 아이콘을 렌더
   - 테스트: 반복 필드가 있는 이벤트를 렌더했을 때 DOM에 아이콘이 존재하는지 확인

 - 3.2 목록 렌더 (단위/통합)
   - 캘린더와 동일한 규칙으로 목록에서 아이콘 표시

 수용 기준:
 - 캘린더와 목록에서 반복 이벤트에만 아이콘이 표시되고 단일 이벤트에는 표시되지 않음

 ---

 ## 4) 반복 종료(termination)
 목표: 반복 종료일을 지정할 수 있어야 하며, 확장은 2025-12-31로 제한해야 합니다.

 세부 작업:
 - 4.1 UI: 종료일 입력 및 검증 (통합)
   - endDate가 제공되면 시작일 이후인지 검증
   - 테스트: 잘못된 endDate에 대해 검증 에러 발생

 - 4.2 유틸: endDate와 cap 적용 (단위)
   - 확장은 min(endDate, 2025-12-31)까지만 수행
   - 테스트: endDate가 cap보다 이후면 cap까지만 생성되는지 확인

 수용 기준:
 - UI에서 endDate가 강제되고 확장 로직이 cap을 적용함

 ---

 ## 5) 편집 플로우: 단일 인스턴스 vs 전체 시리즈
 목표: 반복 시리즈의 한 인스턴스를 수정할 때 "해당 일정만 수정하시겠어요?" 선택지를 제공하고 동작을 분기합니다.

 세부 작업:
 - 5.1 UI: 편집 다이얼로그에 예/아니오 선택 (통합)
   - '예' 선택 시: 해당 날짜의 인스턴스만 비반복(단일) 이벤트로 변경
   - '아니오' 선택 시: 반복 규칙 자체를 수정(시리즈 전체에 적용)
   - 테스트:
     - '예' 경로: 선택한 날짜만 변경되고 다른 인스턴스는 영향을 받지 않음
     - '아니오' 경로: 규칙이 변경되어 발생 인스턴스가 변경됨

 수용 기준:
 - 두 분기 모두 구현되고 테스트로 검증됨

 구현 노트:
 - 단일 인스턴스 수정은 그 날짜를 별도 이벤트로 생성해 오버라이드하는 방식 권장

 ---

 ## 6) 삭제 플로우: 단일 인스턴스 vs 전체 시리즈
 목표: 삭제 시에도 단일 인스턴스 삭제와 시리즈 전체 삭제를 선택할 수 있어야 합니다.

 세부 작업:
 - 6.1 UI: 삭제 다이얼로그(예/아니오) (통합)
   - '예' 선택 시: 해당 인스턴스만 삭제
   - '아니오' 선택 시: 반복 규칙에 해당하는 모든 인스턴스 삭제
   - 테스트:
     - 단일 삭제: 해당 날짜만 삭제되는지 확인
     - 전체 삭제: 모든 인스턴스가 삭제되는지 확인

 수용 기준:
 - 사용자 선택에 따라 단일/전체 삭제가 올바르게 수행됨

 ---

 ## 7) 겹침 규칙(Overlap)
 목표: 명세에 따라 반복 일정은 일정 겹침을 고려하지 않습니다.

 세부 작업:
 - 7.1 겹침 검사 로직이 반복 확장 결과를 별도 처리하지 않고 일반 이벤트처럼 취급하는지 확인
 - 7.2 이 동작을 검증하는 단위/통합 테스트 추가

 ---

 ## 테스트 우선순위 & 매핑
 우선순위(높음):
 - 반복 확장 유틸 단위 테스트 (daily/weekly/monthly-31/yearly-2/29, cap)
 - 폼 렌더 및 저장 테스트(반복 필드 정확성)

 중간 우선순위:
 - 편집/삭제 예/아니오 플로우 통합 테스트
 - 캘린더/목록 아이콘 렌더 테스트

 낮음 우선순위:
 - 대규모 범위에 대한 성능/스트레스 테스트

 ---

 ## 파일 위치 및 테스트 제안
 - `src/utils/repeatUtils.ts` — 핵심 확장 로직
 - `src/__tests__/unit/easy.repeatUtils.spec.ts` — 핵심 로직 단위 테스트
 - `src/__tests__/integration/repeatForm.spec.tsx` — 폼 → 저장 → 확장 통합 테스트
 - `src/__tests__/unit/red.repeatOptions.spec.tsx` — UI의 작은 레드/그린 테스트

 ---

 ## 구현 팁
 - 확장 함수는 순수 함수로 작성하고 테스트에서 `vi.setSystemTime(...)`로 시간 고정
 - 매월 31일 및 2월 29일 규칙은 날짜를 이동(shift)하지 말고 해당 날짜가 존재하는 경우에만 생성하도록 명시적으로 구현
 - jsdom 환경의 MUI Select는 불안정하므로 테스트 전용 fallback(nati ve select)이나 `userEvent.selectOptions()` 사용 권장

 ---

 문서 끝.
